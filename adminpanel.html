<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Panel</title>
  <style>
    #adminPanel {
      display: none;
    }
    button {
      display: block;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
    }
    input {
      padding: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div id="passwordContainer">
  <h2>Введите пароль</h2>
  <input type="password" id="adminPassword" placeholder="Пароль">
  <button onclick="submitPassword()">Войти</button>
</div>

<div id="adminPanel">
  <h1>Панель администратора</h1>

  <button onclick="resetVotingStatuses()">Сбросить статус голосования всем пользователям</button>
  <button onclick="deleteAllUsers()">Удалить всех пользователей (включая localStorage)</button>

  <h3>Удаление пользователя по Civil Number</h3>
  <input type="text" id="civilInput" placeholder="Введите гражданский номер">
  <button onclick="deleteUserByCivilnumber()">Удалить пользователя</button>
</div>

<script>
  const user = JSON.parse(localStorage.getItem('user'));
  if (
    !user ||
    user.civilnumber !== '00010' ||
    user.fullname !== 'Мярьянов Вадим Маркович' ||
    user.status !== 'approved'
  ) {
    window.location.href = 'index.html';
  }

  function submitPassword() {
    const password = document.getElementById('adminPassword').value;

    fetch('http://localhost:3000/api/check-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('passwordContainer').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
        } else {
          alert('Неверный пароль');
        }
      })
      .catch(err => alert('Ошибка: ' + err));
  }

  function resetVotingStatuses() {
    const storedUser = JSON.parse(localStorage.getItem('user'));
    if (storedUser && storedUser.votingStatus === 'vote') {
      storedUser.votingStatus = 'novote';
      localStorage.setItem('user', JSON.stringify(storedUser));
    }

    fetch('http://localhost:3000/api/reset-voting-status', {
      method: 'DELETE'
    })
      .then(response => response.json())
      .then(data => {
        alert(data.message || 'Голоса сброшены');
      })
      .catch(err => {
        alert('Ошибка при удалении голосов: ' + err);
      });
  }

  function deleteAllUsers() {
    if (confirm('Вы уверены, что хотите удалить ВСЕХ пользователей?')) {
      fetch('http://localhost:3000/api/users', {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          localStorage.clear();
        })
        .catch(err => alert('Ошибка: ' + err));
    }
  }

  function deleteUserByCivilnumber() {
    const civil = document.getElementById('civilInput').value.trim();
    if (!civil) return alert('Введите гражданский номер');

    fetch(`http://localhost:3000/api/user/${civil}`, {
      method: 'DELETE'
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(`Пользователь ${data.user.fullname} удалён`);
          const currentUser = JSON.parse(localStorage.getItem('user'));
          if (currentUser && currentUser.civilnumber === civil) {
            localStorage.removeItem('user');
          }
        } else {
          alert(data.message);
        }
      })
      .catch(err => alert('Ошибка: ' + err));
  }
</script>

</body>
</html>
