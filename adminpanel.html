<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админ-панель</title>

  <link rel="icon" href="image/favicon/favicon-64x64.png" sizes="64x64" type="image/png">
  <link rel="icon" href="image/favicon/favicon-48x48.png" sizes="48x48" type="image/png">
  <link rel="icon" href="image/favicon/favicon-32x32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="image/favicon/favicon-16x16.png" sizes="16x16" type="image/png">

  <style>
    button, input {
      display: block;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
<div id="auth-section">
  <h2>Введите пароль администратора</h2>
  <input type="password" id="admin-password" placeholder="Пароль">
  <button onclick="submitAdminPassword()">Войти</button>
</div>

<div id="admin-content"></div>

<script>
  const user = JSON.parse(localStorage.getItem('user'));
  if (
    !user ||
    user.civilnumber !== '00010' ||
    user.fullname !== 'Мярьянов Вадим Маркович' ||
    user.status !== 'approved'
  ) {
    window.location.href = 'index.html';
  }

  async function submitAdminPassword() {
    const password = document.getElementById('admin-password').value;

    const res = await fetch('http://localhost:3000/api/admin-login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });

    const data = await res.json();

    if (res.ok && data.token) {
      sessionStorage.setItem('adminToken', data.token);

      const panel = await fetch('http://localhost:3000/api/admin-content', {
        headers: {
          'Authorization': `Bearer ${data.token}`
        }
      });

      if (panel.ok) {
        const html = await panel.text();
        document.getElementById('auth-section').remove();
        document.getElementById('admin-content').innerHTML = html;
        attachAdminLogic();
      } else {
        alert('Ошибка загрузки панели');
      }

    } else {
      alert('Неверный пароль');
    }
  }

  function attachAdminLogic() {
    window.resetVotingStatuses = function() {
      const storedUser = JSON.parse(localStorage.getItem('user'));
      if (storedUser && storedUser.votingStatus === 'vote') {
        storedUser.votingStatus = 'novote';
        localStorage.setItem('user', JSON.stringify(storedUser));
      }

      fetch('http://localhost:3000/api/reset-voting-status', {
        method: 'POST'
      })
        .then(response => response.json())
        .then(data => alert(data.message || 'Голоса сброшены'))
        .catch(err => alert('Ошибка при удалении голосов: ' + err));
    };

    window.deleteAllUsers = function() {
      if (confirm('Вы уверены, что хотите удалить ВСЕХ пользователей?')) {
        fetch('http://localhost:3000/api/users', {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            localStorage.clear();
          })
          .catch(err => alert('Ошибка: ' + err));
      }
    };

    window.deleteUserByCivilnumber = function() {
      const civil = document.getElementById('civilInput').value.trim();
      if (!civil) return alert('Введите гражданский номер');

      fetch(`http://localhost:3000/api/user/${civil}`, {
        method: 'DELETE'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Пользователь ${data.user.fullname} удалён`);
            const currentUser = JSON.parse(localStorage.getItem('user'));
            if (currentUser && currentUser.civilnumber === civil) {
              localStorage.removeItem('user');
            }
          } else {
            alert(data.message);
          }
        })
        .catch(err => alert('Ошибка: ' + err));
    };
    window.simplifyCheck = function() {
      fetch('http://localhost:3000/api/simplify-check', { method: 'POST' })
        .then(res => res.json())
        .then(data => alert(data.message))
        .catch(err => alert('Ошибка: ' + err));
    };

    window.restoreCheck = function() {
      fetch('http://localhost:3000/api/restore-check', { method: 'POST' })
        .then(res => res.json())
        .then(data => alert(data.message))
        .catch(err => alert('Ошибка: ' + err));
    };
  }

</script>

</body>
</html>
